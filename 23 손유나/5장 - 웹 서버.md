### 5.1 다채로운 웹 서버

- 모든 웹 서버는 리소스에 대한 HTTP 요청을 받아서 콘텐츠를 클라이언트에게 돌려줌.

---

### 5.3 진짜 웹 서버가 하는 일

- **모든 웹 서버가 공통적으로 수행하는 일**
    1. **커넥션을 맺음**
        - 클라이언트의 접속을 받아들이거나, 원치 않는 클라이언트라면 닫음
    2. **요청을 받음**
        - HTTP 요청 메시지를 네트워크로부터 읽어 들임
    3. **요청 처리**
        - 요청 메시지를 해석하고 행동을 취함
    4. **리소스 접근**
        - 메시지에서 지정한 리소스에 접근함
    5. **응답 생성**
        - 올바른 헤더를 포함한 HTTP 응답 메시지를 생성함
    6. **응답 전송**
        - 응답을 클라이언트에게 돌려줌
    7. **트랜잭션을 로그로 남김**
        - 로그파일에 트랜잭션 완료에 대한 기록을 남김
- **기본 웹 서버 요청의 단계**
    
    <img width="422" height="580" alt="image" src="https://github.com/user-attachments/assets/7d3c5605-52c2-4708-9857-94fef05243c7" />

    

---

### 5.4 1단계) 클라이언트 커넥션 수락

- 클라이언트가 웹 서버에 TCP 커넥션 요청 → 웹 서버는 커넥션을 맺고 TCP 커넥션에서 IP 주소를 추출(어떤 클라이언트인지 확인)
- 웹 서버는 어떤 커넥션이든 마음대로 거절하거나 즉시 닫을 수 있음.
- 대부분의 웹 서버는 역방향 DNS를 사용해서 클라이언트의 IP 주소를 클라이언트의 호스트 명으로 변환하도록 설정됨.
    - 클라이언트 호스트 명은 구체적인 접근 제어와 로깅을 위해 사용
- **호스트 명 룩업**은 웹 트랜잭션을 느려지게 할 수 있음.
    - 호스트 명 룩업 : 호스트 명 → IP 주소, IP 주소 → 호스트 명 질의
- **ident 프로토콜**
    - TCP/IP 네트워크에서 사용자의 신원을 확인하기 위해 고안된 프로토콜
    - 주로 TCP 포트 `113`번을 사용
    - 동작 방식 : 서버가 ident 프로토콜을 통해 연결된 상대방에 대해 “이 연결을 만든 사용자 이름이 무엇인지”를 질의하면, 상대방 시스템의 ident 서버가 해당 포트에 연결된 사용자 정보를 반환
- HTTP 클라이언트의 사용자 이름을 알아내기 위해 ident 프로토콜 사용하기
    
    <img width="529" height="313" alt="image" src="https://github.com/user-attachments/assets/4b20f109-3577-47dd-b5ab-8f02f2023036" />

    

---

### 5.5 2단계) 요청 메시지 수신

- 커넥션에 데이터가 도착하면, 웹 서버는 네트워크 커넥션에서 그 데이터를 읽어 들이고 파싱하여 요청 메시지를 구성함.
- 요청 메시지를 파싱할 때, 웹 서버는 입력 데이터를 네트워크로부터 불규칙적으로 받음. → 파싱해서 이해하는 것이 가능한 수준의 분량을 확보할 때까지 데이터를 네트워크로부터 읽어서 메시지 일부분을 메모리에 임시로 저장해두어야 함.
- 요청 메시지를 편리한 내부 표현 형태로 파싱
    
    <img width="534" height="396" alt="image" src="https://github.com/user-attachments/assets/18469d2d-cd3b-4711-a3e4-763f8a334068" />

    
- **웹 서버 입력/출력 아키텍처**
    
    <img width="535" height="706" alt="image" src="https://github.com/user-attachments/assets/32883c7a-77dd-4e22-9e2b-4046efc2b857" />

    
    - **(a) 단일 스레드 웹 서버**
        - 한 번에 하나씩 요청을 처리
    - **(b)** **멀티프로세스와 멀티스레드 웹 서버**
        - 여러 요청을 동시에 처리
    - **(c) 다중 I/O 서버**
        - 모든 커넥션의 활동을 감시하여, 커넥션에 실제로 해야 할 일이 있을 때만 작업을 수행
    - **(d) 다중 멀티스레드 웹 서버**
        - 멀티스레딩 + 다중화

---

### 5.7 4단계) 리소스의 매핑과 접근

- 웹 서버가 클라이언트에 콘텐츠를 전달하려면, 그 전에 요청 메시지의 URI에 대응하는 알맞은 콘텐츠나 콘텐츠 생성기를 웹 서버에서 찾아서 그 콘텐츠의 원천을 식별해야 함.
- 일반적으로 요청 URI를 **문서 루트** 혹은 **docroot**뒤에 붙여서 리소스를 매핑
    
    <img width="533" height="267" alt="image" src="https://github.com/user-attachments/assets/4742aee1-c82a-4943-864a-5f555de8a850" />

    
- **가상 호스팅된 docroot**
    - 각 사이트에 그들만의 분리된 문서 루트를 주는 방법으로, 하나의 웹 서버에서 여러 개의 웹 서버를 호스팅
    
    <img width="536" height="261" alt="image" src="https://github.com/user-attachments/assets/5fb1ff43-c440-4769-91c0-b4abf49d0efe" />

    
- **사용자별로 다른 docroot**
    - 한 대의 웹 서버에서 각자의 개인 웹 사이트를 만들 수 있도록 해주는 것
    - /~`사용자이름` : 사용자의 개인 문서 루트를 가리킴
    
    <img width="535" height="249" alt="image" src="https://github.com/user-attachments/assets/b15b241d-c77a-495f-819f-371318a7ab86" />

    
- 웹 서버는 정적 리소스뿐만 아니라 **동적 리소스**도 제공
- **서버사이드 인클루드(Server-Side Includes, SSI)**
    - 웹 서버가 HTML 페이지를 클라이언트에게 보내기 전에 특수 주석 형식의 명령을 처리하여 동적으로 콘텐츠를 삽입하는 기술

---

### 5.8 5단계) 응답 생성

- **트랜잭션에 응답 본문이 있을 때 포함해야하는 것**
    - 응답 본문의 MIME 타입을 서술하는 `Content-Type` 헤더
    - 응답 본문의 길이를 서술하는 `Content-Length` 헤더
    - 실제 응답 본문의 내용
- 웹 서버는 특정 파일이 특정 MIME 타입을 갖게끔 설정 가능
- 웹 서버는 종종 성공 메시지 대신 리다이렉션 응답을 반환
    - Location 응답 헤더는 콘텐츠의 새로운 위치 또는 선호하는 위치에 대한 URI를 포함
    - **리다이렉트가 유용한 경우**
        - 영구히 리소스가 옮겨진 경우 (`301` Moved Permanently)
        - 임시로 리소스가 옮겨진 경우 (`303` See Other, `307` Temporary Redirect)
        - URL 증강
            - 상태 정보를 내포한 새로운 URL을 생성하여 사용자를 이 새 URL로 리다이렉트
            - 트랜잭션 간 상태를 유지하는 유용한 방법
            - `303` See Other, `307` Temporary Redirect
        - 부하 균형 (`303` See Other, `307` Temporary Redirect)
        - 친밀한 다른 서버가 있을 때
            - 웹 서버는 어떤 사용자에 대한 정보를 가질 수 있기 때문에, 그 클라이언트에 대한 정보를 갖고 있는 다른 서버로 리다이렉트 할 수 있음
            - `303` See Other, `307` Temporary Redirect
        - 디렉터리 이름 정규화
            - 클라이언트가 디렉터리 이름에 대한 URI를 요청할 때 끝에 빗금(`/`)을 빠뜨렸다면, 상대경로가 정상적으로 동작할 수 있도록 클라이언트 슬래시를 추가한 URI로 리다이렉트함

---

### 5.9 6단계) 응답 전송

- **비지속적인 커넥션** : 서버가 모든 메시지를 전송하면 자신 쪽의 커넥션을 닫는 것
- **지속적인 커넥션** : 서버가 `Content-Length` 헤더를 바르게 계산하기 위해 특별한 주의를 필요로 하는 경우나, 클라이언트가 응답이 언제 끝나는지 알 수 없는 경우 커넥션을 열린 상태로 유지하는 것

---

### 5.10 7단계) 로깅

- 트랜잭션이 완료된 후 트랜잭션이 어떻게 수행됐는지에 대한 로그를 로그 파일에 기록
